<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metapopulation Dynamics - Interactive Guide</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-green: #2d5016;
            --secondary-green: #4a7c59;
            --accent-green: #689775;
            --light-green: #8fb996;
            --pale-green: #b8d4c2;
            --background: #f8faf9;
            --dark-text: #1a1a1a;
            --light-text: #666;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background) 0%, var(--pale-green) 100%);
            color: var(--dark-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
            color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(45, 80, 22, 0.3);
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .section {
            background: white;
            margin: 30px 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid var(--accent-green);
        }

        .section h2 {
            color: var(--primary-green);
            margin-bottom: 20px;
            font-size: 2.2em;
            border-bottom: 2px solid var(--pale-green);
            padding-bottom: 10px;
        }

        .section h3 {
            color: var(--secondary-green);
            margin: 25px 0 15px 0;
            font-size: 1.5em;
        }

        .concept-box {
            background: linear-gradient(135deg, var(--pale-green) 0%, rgba(184, 212, 194, 0.3) 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--accent-green);
        }

        .math-equation {
            background: var(--background);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            border: 2px solid var(--pale-green);
            font-size: 1.2em;
        }

        .controls {
            background: var(--pale-green);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .controls label {
            display: block;
            margin: 10px 0 5px 0;
            font-weight: bold;
            color: var(--primary-green);
        }

        .controls input[type="range"] {
            width: 100%;
            margin-bottom: 10px;
        }

        .controls input[type="range"]::-webkit-slider-track {
            background: var(--light-green);
            border-radius: 5px;
        }

        .controls input[type="range"]::-webkit-slider-thumb {
            background: var(--primary-green);
            border-radius: 50%;
            cursor: pointer;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .simulation-grid {
            display: grid;
            grid-template-columns: repeat(10, 30px);
            gap: 2px;
            margin: 20px 0;
            justify-content: center;
        }

        .patch {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid var(--secondary-green);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .patch.occupied {
            background: var(--primary-green);
        }

        .patch.empty {
            background: white;
        }

        .patch.colonizing {
            background: var(--accent-green);
            animation: pulse 0.5s ease-in-out;
        }

        .patch.extinct {
            background: #ffcccb;
            animation: fade 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes fade {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .button {
            background: linear-gradient(135deg, var(--secondary-green) 0%, var(--accent-green) 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--light-green) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .model-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .model-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--pale-green);
            transition: all 0.3s ease;
        }

        .model-card:hover {
            border-color: var(--accent-green);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .model-card h4 {
            color: var(--primary-green);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--secondary-green);
        }

        .tab-container {
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            background: var(--pale-green);
            color: var(--primary-green);
            border: none;
            padding: 12px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--primary-green);
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 10px 10px 10px;
            border: 2px solid var(--pale-green);
        }

        .tab-content.active {
            display: block;
        }

        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Metapopulation Dynamics</h1>
            <p>Interactive Guide to Population-of-Populations Models</p>
        </div>

        <div class="section">
            <h2>Introduction to Metapopulations</h2>
            <div class="concept-box">
                <p><strong>Metapopulation:</strong> A "population of populations" - a group of several local populations linked by immigration and emigration.</p>
            </div>
            
            <p>Unlike traditional population models that assume closed systems, metapopulation models recognize that:</p>
            <ul style="margin: 15px 0; padding-left: 30px;">
                <li>Individuals move between populations</li>
                <li>Local populations can go extinct and be recolonized</li>
                <li>The appropriate scale for understanding persistence is regional, not local</li>
            </ul>

            <h3>Key Conceptual Shifts</h3>
            <div class="responsive-grid">
                <div class="model-card">
                    <h4>Population Size → Persistence</h4>
                    <p>Instead of tracking population size (N), we track whether populations exist (1) or are extinct (0).</p>
                </div>
                <div class="model-card">
                    <h4>Local → Regional Scale</h4>
                    <p>Focus shifts from individual population persistence to the fraction of sites occupied across the landscape.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Extinction Risk and Multiple Populations</h2>
            
            <div class="concept-box">
                <p><strong>Key Insight:</strong> Multiple patches "spread the risk" of extinction. Even if individual populations are likely to go extinct, a set of populations can persist surprisingly long.</p>
            </div>

            <h3>Mathematical Framework</h3>
            <div class="math-equation">
                <p><strong>Probability of n-year persistence:</strong></p>
                $$P_n = (1 - p_e)^n$$
                <p>where p<sub>e</sub> = probability of local extinction per year</p>
            </div>

            <div class="math-equation">
                <p><strong>Regional persistence (x patches):</strong></p>
                $$P_x = 1 - (p_e)^x$$
                <p>Probability that at least one population persists</p>
            </div>

            <div class="controls">
                <label>Local Extinction Probability (p<sub>e</sub>): <span id="pe-value">0.7</span></label>
                <input type="range" id="pe-slider" min="0.1" max="0.9" step="0.1" value="0.7">
                
                <label>Number of Patches: <span id="patches-value">5</span></label>
                <input type="range" id="patches-slider" min="1" max="20" step="1" value="5">
            </div>

            <div class="chart-container">
                <canvas id="extinctionChart"></canvas>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h4>Single Population</h4>
                    <div class="value" id="single-persistence">8.1%</div>
                </div>
                <div class="stat-card">
                    <h4>Multiple Populations</h4>
                    <div class="value" id="multi-persistence">83.2%</div>
                </div>
                <div class="stat-card">
                    <h4>Risk Reduction</h4>
                    <div class="value" id="risk-reduction">10.3x</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>General Metapopulation Model</h2>
            
            <div class="math-equation">
                <p><strong>Basic Metapopulation Equation:</strong></p>
                $$\frac{df}{dt} = I - E$$
                <p>where f = fraction of sites occupied, I = immigration rate, E = extinction rate</p>
            </div>

            <div class="concept-box">
                <p>This equation is analogous to population growth models, but instead of tracking births and deaths of individuals, we track colonization and extinction of populations.</p>
            </div>

            <h3>Immigration and Extinction Rates</h3>
            <div class="math-equation">
                $$I = p_i(1-f)$$
                $$E = p_e f$$
                <p>where p<sub>i</sub> = probability of colonization, p<sub>e</sub> = probability of extinction</p>
            </div>

            <div class="math-equation">
                <p><strong>General Model:</strong></p>
                $$\frac{df}{dt} = p_i(1-f) - p_e f$$
            </div>
        </div>

        <div class="section">
            <h2>Metapopulation Model Variations</h2>
            
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('island-mainland')">Island-Mainland</button>
                    <button class="tab" onclick="showTab('internal')">Internal Colonization</button>
                    <button class="tab" onclick="showTab('rescue')">Rescue Effect</button>
                    <button class="tab" onclick="showTab('combined')">Combined Model</button>
                </div>

                <div id="island-mainland" class="tab-content active">
                    <h3>Island-Mainland Model</h3>
                    <div class="concept-box">
                        <p><strong>Assumption:</strong> Constant external source of colonists (propagule rain)</p>
                    </div>
                    
                    <div class="math-equation">
                        $$\frac{df}{dt} = p_i(1-f) - p_e f$$
                        $$\hat{f} = \frac{p_i}{p_i + p_e}$$
                    </div>

                    <div class="controls">
                        <label>Colonization Probability (p<sub>i</sub>): <span id="pi-im-value">0.3</span></label>
                        <input type="range" id="pi-im-slider" min="0.1" max="0.8" step="0.1" value="0.3">
                        
                        <label>Extinction Probability (p<sub>e</sub>): <span id="pe-im-value">0.4</span></label>
                        <input type="range" id="pe-im-slider" min="0.1" max="0.8" step="0.1" value="0.4">
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <h4>Equilibrium Occupancy</h4>
                            <div class="value" id="im-equilibrium">42.9%</div>
                        </div>
                        <div class="stat-card">
                            <h4>Persistence Guaranteed</h4>
                            <div class="value">✓</div>
                        </div>
                    </div>
                </div>

                <div id="internal" class="tab-content">
                    <h3>Internal Colonization Model</h3>
                    <div class="concept-box">
                        <p><strong>Assumption:</strong> Colonists come only from occupied patches (p<sub>i</sub> = if)</p>
                    </div>
                    
                    <div class="math-equation">
                        $$\frac{df}{dt} = if(1-f) - p_e f$$
                        $$\hat{f} = 1 - \frac{p_e}{i}$$
                    </div>

                    <div class="controls">
                        <label>Internal Colonization Rate (i): <span id="i-value">0.6</span></label>
                        <input type="range" id="i-slider" min="0.1" max="1.0" step="0.1" value="0.6">
                        
                        <label>Extinction Probability (p<sub>e</sub>): <span id="pe-int-value">0.4</span></label>
                        <input type="range" id="pe-int-slider" min="0.1" max="0.8" step="0.1" value="0.4">
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <h4>Equilibrium Occupancy</h4>
                            <div class="value" id="int-equilibrium">33.3%</div>
                        </div>
                        <div class="stat-card">
                            <h4>Persistence Condition</h4>
                            <div class="value" id="int-condition">i > p<sub>e</sub></div>
                        </div>
                    </div>
                </div>

                <div id="rescue" class="tab-content">
                    <h3>Rescue Effect Model</h3>
                    <div class="concept-box">
                        <p><strong>Assumption:</strong> Immigration reduces extinction probability (p<sub>e</sub> = e(1-f))</p>
                    </div>
                    
                    <div class="math-equation">
                        $$\frac{df}{dt} = p_i(1-f) - ef(1-f)$$
                        $$\hat{f} = \frac{p_i}{e}$$
                    </div>

                    <div class="controls">
                        <label>Colonization Probability (p<sub>i</sub>): <span id="pi-rescue-value">0.3</span></label>
                        <input type="range" id="pi-rescue-slider" min="0.1" max="0.8" step="0.1" value="0.3">
                        
                        <label>Rescue Effect Strength (e): <span id="e-value">0.5</span></label>
                        <input type="range" id="e-slider" min="0.1" max="0.8" step="0.1" value="0.5">
                    </div>

                    <div class="stats">
                        <div class="stat-card">
                            <h4>Equilibrium Occupancy</h4>
                            <div class="value" id="rescue-equilibrium">60.0%</div>
                        </div>
                        <div class="stat-card">
                            <h4>Saturation When</h4>
                            <div class="value">p<sub>i</sub> > e</div>
                        </div>
                    </div>
                </div>

                <div id="combined" class="tab-content">
                    <h3>Combined Model (Internal + Rescue)</h3>
                    <div class="concept-box">
                        <p><strong>Assumption:</strong> Both colonization and extinction depend on f</p>
                    </div>
                    
                    <div class="math-equation">
                        $$\frac{df}{dt} = if(1-f) - ef(1-f)$$
                        <p>Equilibrium depends on relative values of i and e</p>
                    </div>

                    <div class="model-comparison">
                        <div class="model-card">
                            <h4>If i > e</h4>
                            <p>Metapopulation grows until saturation (f → 1)</p>
                        </div>
                        <div class="model-card">
                            <h4>If e > i</h4>
                            <p>Metapopulation contracts to extinction (f → 0)</p>
                        </div>
                        <div class="model-card">
                            <h4>If i = e</h4>
                            <p>Neutral equilibrium - f remains constant</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Interactive Metapopulation Simulation</h2>
            
            <div class="concept-box">
                <p>Watch how metapopulation dynamics unfold over time. Each square represents a habitat patch that can be occupied (green) or empty (white).</p>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--primary-green);"></div>
                    <span>Occupied</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: white;"></div>
                    <span>Empty</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--accent-green);"></div>
                    <span>Colonizing</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffcccb;"></div>
                    <span>Recently Extinct</span>
                </div>
            </div>

            <div class="simulation-grid" id="metapop-grid"></div>

            <div class="controls">
                <label>Colonization Rate: <span id="sim-col-value">0.3</span></label>
                <input type="range" id="sim-col-slider" min="0.1" max="0.8" step="0.1" value="0.3">
                
                <label>Extinction Rate: <span id="sim-ext-value">0.2</span></label>
                <input type="range" id="sim-ext-slider" min="0.1" max="0.8" step="0.1" value="0.2">
                
                <label>Model Type:</label>
                <select id="model-type">
                    <option value="island-mainland">Island-Mainland</option>
                    <option value="internal">Internal Colonization</option>
                    <option value="rescue">Rescue Effect</option>
                </select>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="button" onclick="startSimulation()">Start Simulation</button>
                <button class="button" onclick="stopSimulation()">Stop</button>
                <button class="button" onclick="resetSimulation()">Reset</button>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h4>Time Step</h4>
                    <div class="value" id="time-step">0</div>
                </div>
                <div class="stat-card">
                    <h4>Occupied Patches</h4>
                    <div class="value" id="occupied-patches">50</div>
                </div>
                <div class="stat-card">
                    <h4>Occupancy Rate</h4>
                    <div class="value" id="occupancy-rate">50%</div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="simulationChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>Real-World Examples</h2>
            
            <div class="model-comparison">
                <div class="model-card">
                    <h4>Bay Checkerspot Butterfly</h4>
                    <p><strong>Pattern:</strong> Island-mainland structure</p>
                    <p><strong>Key Feature:</strong> Morgan Hill site serves as persistent source population</p>
                    <p><strong>Dynamics:</strong> Local extinctions followed by recolonization from mainland</p>
                </div>
                
                <div class="model-card">
                    <h4>Heathland Carabid Beetles</h4>
                    <p><strong>Pattern:</strong> Continuous habitat with asynchronous dynamics</p>
                    <p><strong>Key Feature:</strong> Different species show different synchrony levels</p>
                    <p><strong>Dynamics:</strong> Source-sink dynamics prevent regional extinction</p>
                </div>
            </div>

            <div class="concept-box">
                <p><strong>Conservation Insight:</strong> Asynchronous population fluctuations provide natural insurance against regional extinction. When some populations decline, others may be increasing and serve as sources of colonists.</p>
            </div>
        </div>

        <div class="section">
            <h2>Model Assumptions and Limitations</h2>
            
            <div class="responsive-grid">
                <div class="model-card">
                    <h4>Homogeneous Patches</h4>
                    <p>All patches assumed identical in size, quality, and isolation. Reality: patches vary greatly in carrying capacity and connectivity.</p>
                </div>
                
                <div class="model-card">
                    <h4>No Spatial Structure</h4>
                    <p>Distance between patches ignored. Reality: colonization probability decreases with distance.</p>
                </div>
                
                <div class="model-card">
                    <h4>No Time Lags</h4>
                    <p>Instantaneous response to changes. Reality: colonization and establishment take time.</p>
                </div>
                
                <div class="model-card">
                    <h4>Constant Parameters</h4>
                    <p>Fixed colonization and extinction rates. Reality: environmental variation affects these rates.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let extinctionChart, simulationChart;
        let simulationRunning = false;
        let simulationInterval;
        let timeStep = 0;
        let patches = [];
        let occupancyHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            MathJax = {
                tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                }
            };
            
            initializeCharts();
            initializeSimulation();
            setupEventListeners();
            updateExtinctionRisk();
            updateModelCalculations();
        });

        function initializeCharts() {
            // Extinction Risk Chart
            const extinctionCtx = document.getElementById('extinctionChart').getContext('2d');
            extinctionChart = new Chart(extinctionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Single Population',
                        data: [],
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Multiple Populations',
                        data: [],
                        borderColor: '#2d5016',
                        backgroundColor: 'rgba(45, 80, 22, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Persistence Probability vs Number of Patches'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Persistence Probability'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Number of Patches'
                            }
                        }
                    }
                }
            });

            // Simulation Chart
            const simulationCtx = document.getElementById('simulationChart').getContext('2d');
            simulationChart = new Chart(simulationCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Occupancy Rate',
                        data: [],
                        borderColor: '#2d5016',
                        backgroundColor: 'rgba(45, 80, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Metapopulation Dynamics Over Time'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'Fraction Occupied (f)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Steps'
                            }
                        }
                    }
                }
            });
        }

        function initializeSimulation() {
            const grid = document.getElementById('metapop-grid');
            grid.innerHTML = '';
            patches = [];
            
            for (let i = 0; i < 100; i++) {
                const patch = document.createElement('div');
                patch.className = 'patch empty';
                patch.onclick = () => togglePatch(i);
                grid.appendChild(patch);
                
                patches.push({
                    occupied: Math.random() > 0.5,
                    element: patch
                });
            }
            
            updatePatchDisplay();
            timeStep = 0;
            occupancyHistory = [];
            updateSimulationStats();
        }

        function setupEventListeners() {
            // Extinction risk sliders
            document.getElementById('pe-slider').addEventListener('input', updateExtinctionRisk);
            document.getElementById('patches-slider').addEventListener('input', updateExtinctionRisk);
            
            // Model calculation sliders
            document.getElementById('pi-im-slider').addEventListener('input', updateModelCalculations);
            document.getElementById('pe-im-slider').addEventListener('input', updateModelCalculations);
            document.getElementById('i-slider').addEventListener('input', updateModelCalculations);
            document.getElementById('pe-int-slider').addEventListener('input', updateModelCalculations);
            document.getElementById('pi-rescue-slider').addEventListener('input', updateModelCalculations);
            document.getElementById('e-slider').addEventListener('input', updateModelCalculations);
            
            // Simulation sliders
            document.getElementById('sim-col-slider').addEventListener('input', updateSimulationParams);
            document.getElementById('sim-ext-slider').addEventListener('input', updateSimulationParams);
        }

        function updateExtinctionRisk() {
            const pe = parseFloat(document.getElementById('pe-slider').value);
            const patches = parseInt(document.getElementById('patches-slider').value);
            
            document.getElementById('pe-value').textContent = pe;
            document.getElementById('patches-value').textContent = patches;
            
            // Calculate probabilities
            const singlePersistence = Math.pow(1 - pe, 5); // 5-year persistence
            const multiPersistence = 1 - Math.pow(pe, patches);
            const riskReduction = multiPersistence / singlePersistence;
            
            document.getElementById('single-persistence').textContent = (singlePersistence * 100).toFixed(1) + '%';
            document.getElementById('multi-persistence').textContent = (multiPersistence * 100).toFixed(1) + '%';
            document.getElementById('risk-reduction').textContent = riskReduction.toFixed(1) + 'x';
            
            // Update chart
            const labels = [];
            const singleData = [];
            const multiData = [];
            
            for (let x = 1; x <= 20; x++) {
                labels.push(x);
                singleData.push(Math.pow(1 - pe, 5)); // Same for all (single population)
                multiData.push(1 - Math.pow(pe, x));
            }
            
            extinctionChart.data.labels = labels;
            extinctionChart.data.datasets[0].data = singleData;
            extinctionChart.data.datasets[1].data = multiData;
            extinctionChart.update();
        }

        function updateModelCalculations() {
            // Island-Mainland Model
            const pi_im = parseFloat(document.getElementById('pi-im-slider').value);
            const pe_im = parseFloat(document.getElementById('pe-im-slider').value);
            const equilibrium_im = pi_im / (pi_im + pe_im);
            
            document.getElementById('pi-im-value').textContent = pi_im;
            document.getElementById('pe-im-value').textContent = pe_im;
            document.getElementById('im-equilibrium').textContent = (equilibrium_im * 100).toFixed(1) + '%';
            
            // Internal Colonization Model
            const i = parseFloat(document.getElementById('i-slider').value);
            const pe_int = parseFloat(document.getElementById('pe-int-slider').value);
            const equilibrium_int = Math.max(0, 1 - pe_int / i);
            
            document.getElementById('i-value').textContent = i;
            document.getElementById('pe-int-value').textContent = pe_int;
            document.getElementById('int-equilibrium').textContent = (equilibrium_int * 100).toFixed(1) + '%';
            
            // Rescue Effect Model
            const pi_rescue = parseFloat(document.getElementById('pi-rescue-slider').value);
            const e = parseFloat(document.getElementById('e-slider').value);
            const equilibrium_rescue = Math.min(1, pi_rescue / e);
            
            document.getElementById('pi-rescue-value').textContent = pi_rescue;
            document.getElementById('e-value').textContent = e;
            document.getElementById('rescue-equilibrium').textContent = (equilibrium_rescue * 100).toFixed(1) + '%';
        }

        function updateSimulationParams() {
            const col = parseFloat(document.getElementById('sim-col-slider').value);
            const ext = parseFloat(document.getElementById('sim-ext-slider').value);
            
            document.getElementById('sim-col-value').textContent = col;
            document.getElementById('sim-ext-value').textContent = ext;
        }

        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        function togglePatch(index) {
            patches[index].occupied = !patches[index].occupied;
            updatePatchDisplay();
            updateSimulationStats();
        }

        function updatePatchDisplay() {
            patches.forEach(patch => {
                if (patch.occupied) {
                    patch.element.className = 'patch occupied';
                } else {
                    patch.element.className = 'patch empty';
                }
            });
        }

        function updateSimulationStats() {
            const occupied = patches.filter(p => p.occupied).length;
            const occupancyRate = occupied / patches.length;
            
            document.getElementById('time-step').textContent = timeStep;
            document.getElementById('occupied-patches').textContent = occupied;
            document.getElementById('occupancy-rate').textContent = (occupancyRate * 100).toFixed(1) + '%';
        }

        function startSimulation() {
            if (simulationRunning) return;
            
            simulationRunning = true;
            occupancyHistory = [];
            
            simulationInterval = setInterval(() => {
                simulateTimeStep();
                timeStep++;
                updateSimulationStats();
                updateSimulationChart();
            }, 500);
        }

        function stopSimulation() {
            simulationRunning = false;
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
        }

        function resetSimulation() {
            stopSimulation();
            timeStep = 0;
            occupancyHistory = [];
            initializeSimulation();
            updateSimulationChart();
        }

        function simulateTimeStep() {
            const colRate = parseFloat(document.getElementById('sim-col-slider').value);
            const extRate = parseFloat(document.getElementById('sim-ext-slider').value);
            const modelType = document.getElementById('model-type').value;
            
            const currentOccupancy = patches.filter(p => p.occupied).length / patches.length;
            
            const newPatches = patches.map(patch => ({ ...patch }));
            
            patches.forEach((patch, index) => {
                if (patch.occupied) {
                    // Extinction process
                    let extinctionProb = extRate;
                    
                    if (modelType === 'rescue') {
                        extinctionProb = extRate * (1 - currentOccupancy);
                    }
                    
                    if (Math.random() < extinctionProb) {
                        newPatches[index].occupied = false;
                        patch.element.className = 'patch extinct';
                        setTimeout(() => {
                            if (!newPatches[index].occupied) {
                                patch.element.className = 'patch empty';
                            }
                        }, 300);
                    }
                } else {
                    // Colonization process
                    let colonizationProb = colRate;
                    
                    if (modelType === 'internal') {
                        colonizationProb = colRate * currentOccupancy;
                    }
                    
                    if (Math.random() < colonizationProb) {
                        newPatches[index].occupied = true;
                        patch.element.className = 'patch colonizing';
                        setTimeout(() => {
                            if (newPatches[index].occupied) {
                                patch.element.className = 'patch occupied';
                            }
                        }, 300);
                    }
                }
            });
            
            patches = newPatches;
            
            // Record occupancy for chart
            const newOccupancy = patches.filter(p => p.occupied).length / patches.length;
            occupancyHistory.push(newOccupancy);
        }

        function updateSimulationChart() {
            const labels = occupancyHistory.map((_, index) => index);
            
            simulationChart.data.labels = labels;
            simulationChart.data.datasets[0].data = occupancyHistory;
            simulationChart.update();
        }

        // Add some educational interactions
        function showEquation(type) {
            const equations = {
                basic: "df/dt = I - E",
                detailed: "df/dt = p_i(1-f) - p_e*f",
                equilibrium: "f̂ = p_i/(p_i + p_e)"
            };
            
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} equation:\n${equations[type]}`);
        }

        // Add explanatory tooltips
        function addTooltips() {
            const tooltips = document.querySelectorAll('[data-tooltip]');
            tooltips.forEach(element => {
                element.addEventListener('mouseenter', function() {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = this.getAttribute('data-tooltip');
                    document.body.appendChild(tooltip);
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.top - 30) + 'px';
                });
                
                element.addEventListener('mouseleave', function() {
                    const tooltip = document.querySelector('.tooltip');
                    if (tooltip) tooltip.remove();
                });
            });
        }

        // Initialize tooltips when DOM is ready
        document.addEventListener('DOMContentLoaded', addTooltips);

        // Add CSS for tooltips
        const tooltipCSS = `
            .tooltip {
                position: absolute;
                background: var(--primary-green);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 0.9em;
                z-index: 1000;
                pointer-events: none;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                max-width: 200px;
            }
            
            .tooltip::after {
                content: '';
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -5px;
                border-width: 5px;
                border-style: solid;
                border-color: var(--primary-green) transparent transparent transparent;
            }
        `;
        
        const style = document.createElement('style');
        style.textContent = tooltipCSS;
        document.head.appendChild(style);
    </script>
</body>
</html>
